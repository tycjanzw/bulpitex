<!DOCTYPE html>
<html>
<head>
    <style>
        body {background-color: rgb(128, 128, 128);}

        #cords { list-style-type: none; margin: 0; padding: 0; }

        video {
        background: #222;
            margin: 0 0 20px 0;
            --width: 60%;
            width: var(--width);
            height: calc(var(--width) * 0.75);
        }

    </style>
</head>
<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <div id="container">

        <div id="left" style="background-color: rgb(3, 118, 219); width: 25%; height: 95vh;float: left;">
            <div id="dane">
                <div id="screenSize">
                    <span id="widthScreen" hidden></span>
                    <span id="heigthScreen" hidden></span>
                </div>
            </div>

            <id id="form" hidden>
                X: <input type="text" id='x' /> <br />
                Y: <input type="text" id='y' /> <br />
                <button>Ustaw</button> <br />
            </id>
            <div class="col-md-4">
                <div class="thumbnail">
                    <img
                    src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAgVBMVEUAeNf///8Addb8/P6TtecAc9br7/lqm94Ab9WvwekAcdYAdNY5gNjg5/b3+Pze5PQvgtmvxetMitqku+e2yOxmlt06hdmPrOTT3PKDq+Rpmt5/o+Hy9PrI1fB1n+DAz+5Xk90Aa9UkfNhPiNqRsOUAZ9Ncj9ymvujB0e5xmt5JjdxeNN2DAAAEBUlEQVR4nO3bjXKiMBQFYLgY/AkoWFEUqEpdtb7/A24CVVGDiqxL6JyvMzvTVjs5m0tCSDQMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANAAG8ivGv80HeAB8mb9emYeNR3iHhqHZl3hQeeI06R2QNNMpk3HKMfnw3+QcDjnTQcpxTqWaKFVh3x/R9/RJktoB+veq9aB3YaEi9dHClq0ImG3RsIuEjYMCR9CwsYh4UNI2DgkfAgJG4eEDyFh45DwISRsXP2Ev3+Nv3B/eUIjjXx3+KsTGry37dT6A+/1akJiGZ69kfTN92JC3mPb2Yc0+6Ie1znfKwnJ8KLwvBUQJ5Fn6JyxckI6dNyrXQt3M9U4YsWExDcjxc5MGKXaZqyWkBxfvVUV++9tZg2VEnKnfLMx+fPmlr6qSsL728WJpuNNlYTqHjyV7VLPa7FCwl5fFdDeHDvW+nh7a1/xfEJaKYeYTzY+jq72SsdOfD4hV16EARmcWac6fX+DK3s6Yb7hf92DARPjy+T0/beGnfizj99j98h2O4outD/JIO8c0Ax7Tee5lSWM/c5dY1GKn/FtwEieqPKLfathmT5z2iReiK76UPSg/AMXAc2NfithVd9cGx3EeuJ2Ltxy8R80ufxZomOZfjw8FJWI5dGquKCwsmtyKQYZ+rYvXupqWKYG77h2OVmDk9SgRaGrh5vBRP586YnrM7hYS8VbDUdTY3DolllEsv2+CNItrHk3JAZQEdGaiIgUFct8GOiY0KBSbJollM99zwntFTcolRegtZNvL5790zRhORorEpojh47z/G4tfhdYrU9IlwnNWEQ01nlEkXXz6/pQzh/yPGk23Oy84kwZtzPh3hGzxeWsMArEL1P5SGMYFkca22m6yRXlCcMx3SzvxQxisKvY8qX63dPclyeU67708uZltBUT6fT2ZtwfNN3kivKEVkQGuzgPHjrc4AfFc0UtJ/x78oTZTc24cO8ipws+VQS01023uCq2yK401xM16Z978CB7ULXk13iTTYmYt89bHom7mPFxWJH3NOqArs5P989o8HMKn3/NjoUYruUi5OcbyzeYYpAR5m0ISOm4H8anD1IcfYvyW58uvL7qGtT0QdQ1OkyUy8VRSoU6ta53n/LXaP3ppyNnqWq7sJOtj25m+AI3aMMwQ6o5LmN3Zfvn5Y884m0bAopCLEtourIG6bOsF+1VKwLK0zH7kscZ8V6OI4wligfD5nDi6PvhtSs0cEp85SMln4fXY9EwjLQ+jVEVm873hVq17OXGaUmFPo2lwbyfjKRkN1+1p0ArIEq9nN6nhQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4D/6Cw/tPqRHs1UZAAAAAElFTkSuQmCC"
                    class="img-fluid rounded-pill"
                    alt=""
                  />
                  <div><h1>Bulpitex</h1></div>
                     

                </div>
            </div>
              <br>
            <div id="role">
                <h5>Ustaw rolę jaką masz pełnić</h5>
            </div>
            <div id="roleInfo">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="roleData">Rola</span>
                    </div>
                        <select class="form-control form-control-sm" id="roleSelected">
                        <option value=""></option>
                        <option value="client">client</option>
                        <option value="server">server</option>
                      </select>
                  </div> 
                <button type="button" id="setRole" class="btn btn-dark" data-toggle="button" aria-pressed="false" autocomplete="off">
                    Ustaw rolę
                  </button>
            </div><br>

            <div id="danePeer">
                <div id="showPeer" hidden></div>         
                   <button type="button" id = "sendPeerCode" class="btn btn-dark" data-toggle="button" aria-pressed="false" autocomplete="off">
                    Wygeneruj kod
                  </button>
                  <br>
                <div class="container" id="generatedCode">
                </div>
                <input class="form-control form-control-sm" id="peerID" type="text" placeholder="Wpisz kod peer"><br>
                    <button type="button" id="callPeer" class="btn btn-success" data-toggle="button" aria-pressed="false" autocomplete="off">Połącz się</button> 
                    <button type="button" id="reconnectBtn" class="btn btn-danger" data-toggle="button" aria-pressed="false" autocomplete="off" disabled>Rozłącz się</button> 
                <br>
    
            </div>

            <ul id="cords"></ul>
            <div id="controlScreenSize"></div>
        </div>

        <div id="right" style="width: 75%; float: left;">
            <div id="screenShareBtn" style="cursor: pointer;" disabled hidden>Udostępnij ekran</div>
            <!--<div id="screen" style="background-color: black; width: 800px; height:500px;"></div>-->
            <!--<video id="screenShare" autoplay playsinline muted hidden></video>
            <video id="screenControl" autoplay playsinline muted hidden></video>-->
            
            <button type="button" id="fullScreen">Pełny ekran</button> <br />
            <div id="remoteScreen" oncontextmenu="return false;"></div>
                
            </div>
            
            <!--<video id="screenControl" autoplay playsinline muted style="visibility: hidden;">-->
            
        </div>

        <div style="clear: both;"></div>

    </div>

    
    <script src="static/dane.js"></script>
    <script src="socket.io/socket.io.js"></script>
    <!--<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>-->
    <!--<script src="static/peer.min.js"></script>-->
    

    <script>
        var socket = io();
        
        var role='';
        var run = false;
        var isOnRemoteDiv = false;
        var isfullScreen = false;
        
        var input = document.getElementById('x');
        var input2 = document.getElementById('y');
        var roleVal = document.getElementById('roleData');
        //var screen = document.getElementById('screenShare');
        var screen = document.getElementById('remoteScreen');    

        document.getElementById('form').addEventListener('click',function(e){
            if(input.value && input2.value){
                socket.emit('sendCoordsFromInputs', {x:input.value, y:input2.value});
                input.value = '';
                input2.value = '';
            }
        });

        screen.addEventListener('click',function(e){
            //e.preventDefault();
            if(roleVal.value){
                role=roleVal.value;
                $('#role').html(role);
                console.log(role);
                run=true;
            }
        });
        

        screen.addEventListener('mousemove',function(e){
            var posX = $(this).offset().left;
            var posY = $(this).offset().top;
            
            var x = e.pageX - posX;
            var y = e.pageY - posY;
            var str = x+" "+y;
            //$('#cords').html(str);
            if(screen.disabled){
                socket.emit('sendCoords',{x:x, y:y});
            }
            if(run && role=='client'){
                socket.emit('sendCoordFromMouseMove',{x:x, y:y,r:role});
            }
        });


        socket.on('setCoordsToDiv', function(data){
            $('#cords').html(data.x+" "+data.y);
        });

        jQuery.fn.single_double_click = function(single_click_callback, double_click_callback, timeout) {
            return this.each(function(){
                var clicks = 0, self = this;
                jQuery(this).click(function(event){
                    clicks++;
                    if (clicks == 1) {
                        setTimeout(function(){
                        if(clicks == 1) {
                            single_click_callback.call(self, event);
                        } else {
                            double_click_callback.call(self, event);
                        }
                    clicks = 0;
                    }, timeout || 300);
                }
            });
            });
        }

        document.getElementById('remoteScreen').addEventListener('mouseup', function(event){
            if(!screen.disabled){
                if (event.button == 2){
                    socket.emit('sendRightClick');
                }
            }
        });

        $("#screenShare").single_double_click(function(event){
            if(!screen.disabled){
                var posX = $(this).offset().left;
                var posY = $(this).offset().top;
                
                var x = event.pageX - posX;
                var y = event.pageY - posY;
                //alert("1 kliknięcie "+x+" "+y);
                socket.emit('sendClick',{x:x,y:y});
            }
        },function(event){
            if(!screen.disabled){
                var posX = $(this).offset().left;
                var posY = $(this).offset().top;
                
                var x = event.pageX - posX;
                var y = event.pageY - posY;
                //alert("2 kliknięcia "+x+" "+y);
                socket.emit('sendDoubleClick',{x:x,y:y});
            }
        });

        /*$(window).bind('keyup', function(e){
            socket.emit('sendKey',{k:e.key});
        });*/
        

        /////////////
        /////////////
        /////////////
        /////////////

        var peer = new Peer();
        var myStream;
        var currentPeer;
        var peerList = [];

        peer.on('open', function(id){
            $('#showPeer').html(id);
        });

        peer.on('call', function(call){
            call.answer(myStream);
            call.on('stream', function(remoteStream){
                addRemoteVideo(remoteStream);
            });
        });

        function callPeer(id){
            navigator.mediaDevices.getDisplayMedia({
                video:{
                    cursor: "always"
                }
            }).then((stream)=>{
                myStream = stream;
                let call = peer.call(id, stream);
                call.on('stream', function(remoteStream){
                    if(!peerList.includes(call.peer)){
                        //addRemoteVideo(remoteStream);
                        currentPeer = call.peerConnection;
                        peerList.push(call.peer);
                    }
                })
                stream.getVideoTracks()[0].addEventListener('ended', () => {
                    reconnectStream();
                });
            }).catch((err)=>{
                console.log(err+" nie ma streamu");
            });
        }

        function addRemoteVideo(stream){
            var isMouseDown = false;

            let video = document.createElement('video');
            video.srcObject = stream;
            video.play();
            video.setAttribute('id','videoTest')
            document.getElementById('remoteScreen').append(video);

            $('#videoTest').mouseenter(() => {isOnRemoteDiv = true});
            $('#videoTest').mouseleave(() => {isOnRemoteDiv = false});
        
        }

    </script>

    <div videoTest></div>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="static/WebRTC.js"></script>
    <script src="https://github.com/webrtc/samples/blob/gh-pages/src/js/lib/ga.js"></script>
    <!--<script src="static/scripts.js"></script>-->

</body>
</html>